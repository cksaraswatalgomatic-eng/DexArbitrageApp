<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Advanced ML Analysis - Dex Arbitrage</title>

    <script src="/auth-check.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/design-system.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"></noscript>
    <link rel="stylesheet" href="/light-theme.css" />
    <style>
        .grid-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .full-height-chart {
            height: 500px; /* Taller for better visibility */
            width: 100%;
        }
        .control-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            background: var(--surface);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-val { font-size: 2rem; font-weight: bold; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; }
        
        /* Training modal/overlay */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--surface);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border);
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        
        .row {
            margin-bottom: 1.5rem;
        }
    </style>
  </head>
  <body data-page="ml-analysis-advanced">
    <header class="app-header">
      <div class="brand-block" id="brand">
        <img class="brand-img" src="/color_logo.png" onerror="this.src='/color_logo.svg'" alt="Logo" />
        <div class="brand-text">
          <span class="brand-title">DEX Arbitrage</span>
          <span class="page-label">Advanced ML</span>
        </div>
      </div>
      <div class="primary-nav">
        <button id="nav-dropdown-button" class="icon-btn nav-toggle" aria-haspopup="true" aria-controls="nav-dropdown" aria-expanded="false" aria-label="Toggle navigation">&#9776;</button>
        <nav class="nav-dropdown" id="nav-dropdown" aria-label="Primary navigation">
          <a class="nav-link" data-route="dashboard" href="/">Dashboard</a>
          <a class="nav-link" data-route="pair-analysis" href="/pair-analysis.html">Pair Analysis</a>
          <a class="nav-link" data-route="token-analysis" href="/token-analysis.html">Token Analysis</a>
          <a class="nav-link" data-route="diff-analysis" href="/diff-analysis.html">Diff Analysis</a>
          <a class="nav-link" data-route="ml-dashboard" href="/ml-dashboard.html">ML Analytics</a>
          <a class="nav-link active" data-route="ml-analysis-advanced" href="/ml-analysis-advanced.html">Adv. ML Analysis</a>
          <a class="nav-link" data-route="contract-analysis" href="/contract-analysis.html">Contract Analysis</a>
          <a class="nav-link" data-route="liquidity-monitoring" href="/liquidity-monitoring.html">Liquidity Monitoring</a>
          <a class="nav-link" data-route="reports" href="/reports.html">Reports &amp; Analytics</a>
          <a class="nav-link requires-admin" data-route="consolidated" href="/consolidated-tracking.html" data-requires-role="admin">Consolidated Tracking</a>
        </nav>
      </div>
      <div class="header-actions">
        <button id="theme-switcher" class="icon-btn" title="Toggle Theme" aria-label="Toggle theme">&#127769;</button>
        <label class="field">
          <span class="field-label">Server</span>
          <select id="serverSelect"></select>
        </label>
        <a class="icon-btn" href="/docs.html" title="Documentation" aria-label="Documentation">&#128218;</a>
        <button id="refreshBtn" class="btn-ghost" title="Refresh now" type="button">Refresh</button>
        <button class="icon-btn logout-btn" data-action="logout" title="Log out" aria-label="Log out">&#128274;</button>
      </div>
    </header>

    <main>
        <!-- Controls -->
        <div class="control-bar">
            <div>
                <label>Active Model:</label>
                <span id="activeModelDisplay" style="font-weight:bold;">Loading...</span>
            </div>
            <div style="display:flex; align-items:center; gap:0.5rem; margin-left: 1rem;">
                <label>Trades:</label>
                <select id="limitSelect" style="padding:4px;">
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1,000</option>
                    <option value="2000" selected>2,000</option>
                    <option value="5000">5,000</option>
                    <option value="10000">10,000</option>
                </select>
            </div>
            <div style="flex-grow:1;"></div>
            <button id="btnOpenTrain" class="btn btn-secondary">Train New Model</button>
            <button id="btnRunAnalysis" class="btn btn-primary">Run Market Analysis</button>
        </div>

        <!-- Stats Overview -->
        <div class="grid-4" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom:1.5rem;">
            <div class="stat-card">
                <div class="stat-val" id="statHighProb">--</div>
                <div class="stat-label">High Prob. Tokens (>80%)</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="statAvgProb">--%</div>
                <div class="stat-label">Avg. Market Probability</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="statTotalVol">--</div>
                <div class="stat-label">Total Volume Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="statModelAcc">--%</div>
                <div class="stat-label">Model Accuracy (Test)</div>
            </div>
        </div>

        <!-- 3D Chart Row -->
        <div class="row">
            <section class="card" style="width: 100%;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Market Opportunity Map (3D)</h2>
                    <p class="text-muted small">X: Spread (Buy/Sell), Y: Slippage, Z: Profit Prob.</p>
                </div>
                <div id="scatterChart3D" class="full-height-chart"></div>
            </section>
        </div>
        
        <!-- Distribution Chart Row -->
        <div class="row">
             <section class="card" style="width: 100%;">
                <h2>Prediction Distribution (Confidence)</h2>
                <p class="text-muted small">How many tokens fall into each probability bucket.</p>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="distChart"></canvas>
                </div>
            </section>
        </div>

        <!-- Token Drill Down Section -->
        <section id="tokenDetailsSection" class="card" style="display:none; margin-bottom:1.5rem; border-left: 4px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Token Analysis: <span id="detailTokenName">--</span></h2>
                <button class="btn-ghost" onclick="document.getElementById('tokenDetailsSection').style.display='none'">Close</button>
            </div>
            
            <div class="grid-3" style="display:grid; grid-template-columns: 300px 1fr; gap:1.5rem; margin-top:1rem;">
                <!-- Metrics -->
                <div>
                    <h3>Key Metrics</h3>
                    <ul class="feature-importance-list">
                        <li class="feature-item">
                            <span>Profit Probability</span>
                            <strong id="detailProb">--</strong>
                        </li>
                        <li class="feature-item">
                            <span>Liquidity</span>
                            <span id="detailLiq">--</span>
                        </li>
                        <li class="feature-item">
                            <span>Price</span>
                            <span id="detailPrice">--</span>
                        </li>
                         <li class="feature-item">
                            <span>Spread</span>
                            <span id="detailSpread">--</span>
                        </li>
                    </ul>
                     <div style="margin-top:1rem;">
                        <button id="btnViewPairDetail" class="btn btn-secondary full-width">Open Pair Analysis</button>
                    </div>
                </div>

                <!-- Sensitivity Heatmap -->
                <div style="width:100%;">
                    <h3>Profitability Heatmap</h3>
                    <p class="text-muted small">Profit Probability vs. Price Diff (X) and DEX Slippage (Y)</p>
                    <div id="heatmapContainer" style="height: 400px; width:100%;"></div>
                </div>
            </div>
        </section>

        <!-- Top Opportunities Table -->
        <section class="card">
            <h2>Top Predicted Opportunities</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Current Price</th>
                            <th>Liquidity (Vol)</th>
                            <th>Spread (Bps)</th>
                            <th>Profit Prob.</th>
                            <th>Exp. Profit</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="topTokensTableBody">
                        <tr><td colspan="7" style="text-align:center;">Run analysis to see data...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Train Modal -->
    <div id="trainModal" class="modal">
        <div class="modal-content">
            <h3>Train New Model</h3>
            <div class="field" style="margin: 1rem 0;">
                <label>Model Type</label>
                <select id="trainModelType" class="full-width">
                    <option value="random_forest">Random Forest (Balanced)</option>
                    <option value="gradient_boosting">Gradient Boosting (Better Probabilities)</option>
                    <option value="logistic_regression">Logistic Regression</option>
                </select>
            </div>
            <div class="field" style="margin: 1rem 0;">
                <label>Target</label>
                <select id="trainTarget" class="full-width">
                    <option value="classification">Profit Probability (Classification)</option>
                    <option value="regression">Predicted ROI % (Regression)</option>
                </select>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem;">
                <button class="btn btn-ghost" onclick="document.getElementById('trainModal').style.display='none'">Cancel</button>
                <button id="btnConfirmTrain" class="btn btn-primary">Start Training</button>
            </div>
            <div id="trainStatus" style="margin-top:1rem;"></div>
        </div>
    </div>

    <script src="/chart-loader.js"></script>
    <script src="/ml-analysis-advanced.js"></script>
    <script src="/help.js"></script>
    <script src="/servers-client.js"></script>
    <script src="/theme-switcher.js"></script>
    <script src="/logout.js"></script>
    <script src="/mobile-menu.js"></script>
  </body>
</html>